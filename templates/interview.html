<div id="interviewControls" class="w-1/2">
    <h2 class="w-[90%] mx-auto text-center">{{ question }}</h2>
    <label for="audioDeviceSelect">Select Audio Device:</label>
    <select id="audioDeviceSelect">
        <option value="">Default Device</option>
    </select>
    <div class="mx-auto w-1/3 flex gap-3 justify-center">
        <button id="startRecordButton">Start Response</button>
        <button id="stopRecordButton" disabled hidden hx-post="/stop_record">Submit Response</button>
    </div>
</div>
<div id="results" class="w-[90%] h-[60%]" hidden>
    <h3 class="w-full mx-auto text-center">{{ question }}</h3>
    <div class="w-full flex">
        <div id="audioResults" class="flex-1 bg-red-200/30">
            Audio Results
            <audio id="audioPlayback" controls></audio>
        </div>
        <div id="videoResults" class="flex-1 bg-blue-200/30">
            Video results
        </div>
    </div>
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];
    let stream; // Retain the MediaStream reference

    const startRecordButton = document.getElementById("startRecordButton");
    const stopRecordButton = document.getElementById("stopRecordButton");
    const audioPlayback = document.getElementById("audioPlayback");
    const audioDeviceSelect = document.getElementById("audioDeviceSelect");

    // List available audio input devices
    async function listDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioDevices = devices.filter(device => device.kind === 'audioinput');

        // Populate the device select dropdown with available audio devices
        audioDevices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `Device ${device.deviceId}`;
            audioDeviceSelect.appendChild(option);
        });
    }

    // Call the listDevices function when the page loads
    listDevices();

    startRecordButton.addEventListener("click", async () => {
        try {
            const response = await fetch("/start_record", { method: "POST" });
            const result = await response.json();
            console.log(result.status);  // Log the response from the backend
        } catch (error) {
            console.error("An error occurred:", error);
        }

        // Get the selected audio input device ID
        const deviceId = audioDeviceSelect.value;

        // Get user media with the selected audio device (if any)
        const constraints = deviceId ? { audio: { deviceId: { exact: deviceId } } } : { audio: true };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            audioChunks = [];

            // Play the audio
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayback.src = audioUrl;

            // Upload the audio
            const formData = new FormData();
            formData.append("audio", audioBlob, "recording.webm");

            
            fetch("/upload_audio", {
                method: "POST",
                body: formData,
            }).then(response => response.text())
                .then(html => {
                    // Render the returned HTML in the browser
                    document.open();
                    document.write(html);
                    document.close();
                })
                .catch(error => {
                    console.error("Audio upload failed:", error);
                    alert("Audio upload failed. Please try again.");
                });
        };

        mediaRecorder.start();
        startRecordButton.disabled = true;
        startRecordButton.hidden = true;
        stopRecordButton.disabled = false;
        stopRecordButton.hidden = false;
    });

    stopRecordButton.addEventListener("click", () => {
        mediaRecorder.stop();

        // Stop all tracks in the media stream to free the microphone
        stream.getTracks().forEach(track => track.stop());

        startRecordButton.disabled = false;
        stopRecordButton.disabled = true;
        document.getElementById('interviewControls').hidden = true;
        document.getElementById('results').hidden = false;
    });
</script>
