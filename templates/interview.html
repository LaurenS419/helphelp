<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder</title>
    <link href="../static/output.css" rel="stylesheet">

    <!-- Add the CSS for the animated eyes -->
    <style>
        /* Ensure the wrap is a flexible container with padding and centered eyes */

        .wrap {
            display: block;
            justify-content: center;
            /* Horizontally center the eyes */
            align-items: center;
            /* Vertically center the eyes */
            gap: 1rem;
            /* Space between eyes */
            padding: 2rem;
            /* Padding around the eyes */
            background: transparent;
            /* Transparent background */
            max-width: 100%;
            /* Prevent wrapping */
            width: 100%;
            /* Ensure full width of the parent container */
        }

        .eye {
            width: 80px;
            /* Increase size */
            height: 80px;
            /* Increase size */
            border-radius: 50%;
            background: #fff;
            display: inline-block;
            overflow: hidden;
            /* Ensure they are side by side */
            position: relative;
            /* Positioning for individual eyes */
            margin: 10px;
            /* Space between the eyes */
            z-index: 10;
        }

        .eye:before {
            content: '';
            position: absolute;
            top: 50%;
            /* Center the pupil vertically */
            left: 50%;
            /* Center the pupil horizontally */
            width: 20px;
            /* Size of the pupil */
            height: 20px;
            /* Size of the pupil */
            border-radius: 50%;
            background: rgba(20, 20, 20, 1);
            /* Black color for the pupil */
            transform: translate(-50%, -50%);
            /* Center the pupil exactly in the middle */
        }


        .eye.grin:after,
        .eye.sad:after {
            content: '';
            position: absolute;
            width: calc(100% + 20px);
            height: 0;
            border-radius: 50%;
            background: rgb(245 243 255);
            left: -10px;
        }

        .eye.grin:after {
            bottom: -10px;
        }

        .eye.sad:after {
            top: -10px;
        }

        .eye.blink {
            animation: blink 4s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .eye.double-blink {
            animation: double-blink 4s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .eye.grin:before {
            animation: grinb 4s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .eye.grin:after {
            animation: grina 4s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .eye.sad:before {
            animation: sadb 4s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .eye.sad:after {
            animation: grina 4s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .eye.up:before {
            animation: grinb 4s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .eye.down:before {
            animation: sadb 4s cubic-bezier(0.785, 0.135, 0.15, 0.86) infinite;
        }

        .eye.d1 {
            animation-delay: .1s;
        }

        /* Keyframes for eye animations */
        @keyframes blink {

            0%,
            8% {
                height: 40px;
            }

            10%,
            12% {
                height: 5px;
            }

            14%,
            100% {
                height: 40px;
            }
        }

        @keyframes double-blink {

            0%,
            8% {
                height: 40px;
            }

            10%,
            12% {
                height: 10px;
            }

            13% {
                height: 40px;
            }

            14%,
            16% {
                height: 0;
            }

            18%,
            100% {
                height: 40px;
            }
        }

        @keyframes grinb {

            0%,
            10% {
                bottom: 0;
            }

            20%,
            40% {
                bottom: 50%;
            }

            50%,
            100% {
                bottom: 0;
            }
        }

        @keyframes grina {

            0%,
            10% {
                height: 0;
            }

            20%,
            40% {
                height: 100%;
            }

            50%,
            100% {
                height: 0;
            }
        }

        @keyframes sadb {

            0%,
            10% {
                top: 0;
            }

            20%,
            40% {
                top: 50%;
            }

            50%,
            100% {
                top: 0;
            }
        }
    </style>
</head>

<body class="">
    <div class="w-1/2">
        <h2>{{ question }}</h2>

        <div class="wrap" id="eyes" style="display: none;">
            <div class="eye">
                <div class="eyeball"></div>
            </div>
        </div>

        <label for="audioDeviceSelect" style="display: none;">Select Audio Device:</label>
        <select id="audioDeviceSelect" style="display: none;">
            <option value="">Default Device</option>
        </select>
        <div class="mx-auto w-1/3 flex gap-3 justify-center">
            <button id="recordButton">Start Recording</button>
            <button id="stopButton" disabled hidden>Stop Recording</button>
        </div>
        <audio id="audioPlayback" controls></audio>

        <div id="results">
            <p>Blink Rate: <span id="blinkRate">-</span></p>
            <p>Eye Contact Percentage: <span id="eyeContactPercentage">-</span></p>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let stream; // Retain the MediaStream reference

        const recordButton = document.getElementById("recordButton");
        const stopButton = document.getElementById("stopButton");
        const audioPlayback = document.getElementById("audioPlayback");
        const audioDeviceSelect = document.getElementById("audioDeviceSelect");

        const eyeElement = document.getElementById('eyes');


        // List available audio input devices
        async function listDevices() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const audioDevices = devices.filter(device => device.kind === 'audioinput');

            // Populate the device select dropdown with available audio devices
            audioDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Device ${device.deviceId}`;
                audioDeviceSelect.appendChild(option);
            });
        }

        // Call the listDevices function when the page loads
        listDevices();

        recordButton.addEventListener("click", async () => {
            try {
                const response = await fetch("/start_record", { method: "POST" });
                const result = await response.json();
                console.log(result.status);  // Log the response from the backend
            } catch (error) {
                console.error("An error occurred:", error);
            }

            // Get the selected audio input device ID
            const deviceId = audioDeviceSelect.value;

            // Get user media with the selected audio device (if any)
            const constraints = deviceId ? { audio: { deviceId: { exact: deviceId } } } : { audio: true };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                audioChunks = [];

                // Play the audio
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayback.src = audioUrl;

                // Upload the audio
                const formData = new FormData();
                formData.append("audio", audioBlob, "recording.webm");

                fetch("/upload_audio", {
                    method: "POST",
                    body: formData,
                }).then(response => response.text())
                    .then(html => {
                        // Render the returned HTML in the browser
                        document.open();
                        document.write(html);
                        document.close();
                    })
                    .catch(error => {
                        console.error("Audio upload failed:", error);
                        alert("Audio upload failed. Please try again.");
                    });
            };

            mediaRecorder.start();
            recordButton.disabled = true;
            recordButton.hidden = true;
            stopButton.disabled = false;
            stopButton.hidden = false;

            eyeElement.style.display = 'block'; // Change from 'none' to 'block' to show it
            updateEyes();

        });

        stopButton.addEventListener("click", () => {
            fetch("/stop_record", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    // Display the results
                    document.getElementById("blinkRate").textContent = data.blink_rate;
                    document.getElementById("eyeContactPercentage").textContent = data.eye_contact_percentage;

                    console.log(data.status); // Log the response from the backend
                })
                .catch(error => {
                    console.error("An error occurred:", error);
                });

            mediaRecorder.stop();

            // Stop all tracks in the media stream to free the microphone
            stream.getTracks().forEach(track => track.stop());

            recordButton.disabled = false;
            stopButton.disabled = true;
        });

        // Define possible eye types
        const eyeTypes = ['blink', 'double-blink', 'grin', 'sad', 'up', 'down'];

        // Function to generate a random eye type
        function getRandomEyeType() {
            return eyeTypes[Math.floor(Math.random() * eyeTypes.length)];
        }

        // Function to update eyes within the existing wrap container
        function updateEyes() {
            // Select the existing wrap container

            if (eyeElement.style.display != 'none') {

                const wrap = document.querySelector('.wrap');

                if (wrap) {
                    // Clear the existing eyes inside the wrap container
                    wrap.innerHTML = '';

                    // Generate a random eye type
                    const eyeType = getRandomEyeType();

                    // Create the two eyes
                    const eye1 = document.createElement('div');
                    const eye2 = document.createElement('div');

                    eye1.className = `eye ${eyeType}`;
                    eye2.className = `eye ${eyeType}`;

                    // Append the eyes to the wrap container
                    wrap.appendChild(eye1);
                    wrap.appendChild(eye2);
                }
            }
        }

        // Run the first update on page load
        window.onload = () => {
            updateEyes(); // Initial eyes
            setInterval(updateEyes, 700); // 7 seconds
        };
    </script>
</body>

</html>